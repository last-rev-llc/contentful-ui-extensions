<!DOCTYPE html>
<html>
<head>
  <link
    rel="stylesheet"
    type="text/css"
    href="https://contentful.github.io/ui-extensions-sdk/cf-extension.css">
  <script src="https://unpkg.com/contentful-ui-extensions-sdk@3"></script>
  <script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>
  <title>SEO Extension</title>
</head>
<body>
  <form id="seo-extension">
    <div class="cf-form-field">
      <label>Page Title</label>
      <input type="text" name="title" class="cf-form-input">
      <div class="cf-form-hint">
        This is going to be the title atop the browser window.
      </div>
    </div>
    <div class="cf-form-field">
      <label>Meta Description</label>
      <textarea class="cf-form-input" name="description"></textarea>
      <div class="cf-form-hint">
        This is what's going to show up in the search engine results.
      </div>
    </div>
    <div class="cf-form-field">
      <label>Social Sharing Image</label>
      <input type="text" name="og:image" class="cf-form-input">
      <div class="cf-form-hint">
        This is used by social networks when users share content.
      </div>
    </div>

    <div id="extra-metadata-fields"></div>
  </form>

  <select class="cf-form-input" id="field-selector"></select><button class="cf-btn-primary" id="add-metadata">Add Metadata</button>
  <script>
    window.contentfulExtension.init(function(extension) {
      const setAvailableOptions = (newOption = '') => {
        const currentValue = extension.field.getValue();
        const availableOptions = metadataOptions.filter(meta => currentValue.findIndex(v => v.name === meta.value) < 0 && meta.value !== newOption);
        $('#field-selector').empty().append(availableOptions.map(({ value, label }) => $(`<option value="${value}">${label}</option>`)));
      };

      const init = () => {
        const value = extension.field.getValue();

        value.forEach(meta => {
          const input = $(`[name="${meta.name}"].cf-form-input`);

          if (input.length) {
            input.val(meta.value);
          } else {
            addMetadataField(meta.name, meta.value);
          }
        });

        setAvailableOptions();
        bind();
        $('#add-metadata').on('click', () => addMetadataField($('#field-selector').val()));
      };

      const updateValues = (name, value) => {
        const fieldValue = extension.field.getValue() || [];
        let updatedValue = [];

        const index = fieldValue.findIndex(v => v.name === name);

        if (index < 0) {
          updatedValue = [...fieldValue, { name, value }];
        } else {
          updatedValue = [
            ...fieldValue.slice(0, index),
            { name, value },
            ...fieldValue.slice(index + 1)
          ];
        }

        extension.field.setValue(updatedValue);
      };

      const metadataOptions = [
        {
          value: 'keywords',
          label: 'Meta Keywords',
          help: 'These are the keywords for search engines to take into account.'
        },
        {
          value: 'og:title',
          label: 'Social Sharing Title',
          help: 'This is the title that will appear when users share this content in social networks.'
        },
        {
          value: 'og:description',
          label: 'Social Sharing Description',
          help: 'This is the description snippet that appears when users share to social networks.'
        },
        {
          value: 'twitter:image',
          label: 'Twitter Sharing Image',
          help: 'This is the picture that will appear on the thumbnail when users share to Twitter.'
        },
        {
          value: 'robots',
          label: 'Search Engine Visibility',
          help: 'This sets whether this content will be visible to search engines.',
          options: [{ value: 'index,follow', label: 'Yes' }, { value: 'noindex,nofollow', label: 'No' }]
        }
      ];

      const deleteMetadataField = (el) => (event) => {
        event.preventDefault();
        const input = el.find('input, select');
        const name = input.attr('name');

        const currentValue = extension.field.getValue();
        const index = currentValue.findIndex(v => v.name === name);

        if (index >= 0) {
          extension.field.setValue([
            ...currentValue.slice(0, index),
            ...currentValue.slice(index + 1)
          ]);
        }

        el.remove();
        setAvailableOptions();
      };

      const addMetadataField = (name, initialValue = '') => {
        const metaOption = metadataOptions.find(meta => meta.value === name);
        const labelSelector = $(`<label>${metaOption.label} <a href="#">&times;</a></label>`);
        let inputField = $(`<input type="text" name="${name}" class="cf-form-input">`);
        let helpBlock = $('<div class="cf-form-hint"></div>');
        const field = $('<div class="cf-form-field"></div>');

        if (metaOption.options) {
          inputField = $(`<select class="cf-form-input" name="${name}"></select>`);
          inputField.append(metaOption.options.map(({ value, label }) => $(`<option value="${value}">${label}</option>`)));
        }

        if (initialValue) {
          inputField.val(initialValue);
        }

        helpBlock.html(metaOption.help);

        field.append(labelSelector, inputField, helpBlock);
        $('#extra-metadata-fields').append(field);

        const currentValue = extension.field.getValue();
        extension.field.setValue([
          ...currentValue,
          { name, value: initialValue }
        ]);

        // Filter out existing meta values from the add field selector
        setAvailableOptions(name);
        labelSelector.find('a').click(deleteMetadataField(field));
        rebind();
      };

      const bind = () => {
        $('#seo-extension').find('[name].cf-form-input').change(({ target: { name, value }}) => updateValues(name, value));
      };

      const unbind = () => {
        $('#seo-extension').find('[name].cf-form-input').unbind();
      };

      const rebind = () => {
        unbind();
        bind();
      };

      init();
      extension.window.startAutoResizer();
    });
  </script>
</body>
</html>
