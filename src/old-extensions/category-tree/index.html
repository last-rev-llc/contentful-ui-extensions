<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>jsontree</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="https://contentful.github.io/ui-extensions-sdk/cf-extension.css">
  <style>
    .level-2 > li {padding-left: 1rem;}
    .level-3 > li {padding-left: 2rem;}
    .level-4 > li {padding-left: 3rem;}
    .level-5 > li {padding-left: 4rem;}
    span > i::before { padding-left: 0.5rem; font-weight: bold; font-size: 1.25rem; content: "+";}
    span > i.open::before { content: "-"; }
    .list-group.list-group-root {
      margin-bottom: 0;
      display: flex;
      width: 100%;
      flex-wrap: wrap;
      flex-direction: row;
    }
    .list-group-root > li {
      flex: 0 0 50%;
      max-width: 50%;
      flex-direction: column;
    }

    .list-group-root > li li {
      border: none;
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
    }

    input[type=checkbox] {
      margin-right: 0.5rem;
      display: inline;
      content: "+";
    }
  </style>
</head>

<body>
</body>

</html>
<div id="nested-product-categories"></div>
<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js'></script>
<script type='text/javascript'
  src='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/contentful-ui-extensions-sdk@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.min.js"></script>

<script type='text/javascript'>

  // CHANGE ME!!!
   // TODO: Make install variables
  const space_id = ''
  const access_token = '';
  const rootProductId = '';
  const categoryContentTypeId = '';
  // STOP

  window.contentfulExtension.init(function (extension) {
    window.category_browser = extension
    extension.window.startAutoResizer()
    var id = 0

    function buildTreeWithJSONArray(json, root, linkId, level) {
      var ulContainer = '';
      //Create ul container to hold the current level of categories
      if (linkId === '') {
        ulContainer = $('<ul class="list-group list-group-root in well"></ul>');
      } else {
        ulContainer = $(`<ul class="list-group collapse level-${level}" id="list-${linkId}"></ul>`);
      }

      // for each category defined, add a li element with the appropriate details and add to the ul container
      for (var i = 0; i < json.length; i++) {
        if (json[i].fields && json[i].fields !== 'undefined') {
          var has_subcategories = json[i].fields.subcategory && json[i].fields.subcategory !== 'undefined'
          id++

          var $li = $(`<li class='list-group-item' data-id='${json[i].sys.id}'>
              <input type="checkbox" class="checkbox">
              <span class='list-group-content'>
                ${json[i].fields.name}
                ${ has_subcategories ? `<i href='#list-${id}' data-toggle="collapse"></i>` : '' }
                
              </span>
            </li>`);
          if (has_subcategories) {
            $li.append(buildTreeWithJSONArray(json[i].fields.subcategory, $li, id, level + 1));
          }

          ulContainer.append($li);
        }
      }

      if (linkId === '') {
        root.append(ulContainer);
      } else {
        root.append(ulContainer);
      }
    }

    // get field value and, for each category, check the box, highlight the category,
    // and expand the parents of selected subcategories
    function getFieldValue() {
      const value = extension.field.getValue();
      console.log(value);

      if (value && value !== 'undefined') {
        value.forEach(item => {
          const $category = $('[data-id]').filter(`[data-id=${item.sys.id}]`);

          $category
            .find('input[type=checkbox]').eq(0).prop('checked', true)
            .parents('.collapse').collapse('show')
              .siblings('.list-group-content').find('i').addClass('open')
            
        });
      }
    }

    // when a checkbox is clicked, set css class to highlight the entry,
    // make array of contentful links for all the checked items
    // and set field value to new array
    function setupEventListeners() {
      $('.checkbox').on('click', function(event) {
        var links = [];
        $(':checked').each((i, v) => {
          var $this = $(v);
          links.push({sys: {type: 'Link', linkType: 'Entry', id: $this.closest('[data-id]').attr('data-id')}});
        });
        extension.field.setValue(links);
        event.stopPropagation()
      });

      $('[data-toggle=collapse]').on('click', function(e) {
        $(e.currentTarget).toggleClass('open');
      })
    }

    // get category tree using the CDA, create the tree, set up event listeners, and show the current field value
    const cda = contentful.createClient({space: space_id, accessToken: access_token})
    // TODO: Make these install parameters
    cda.getEntries({content_type: categoryContentTypeId, include: 10, 'sys.id': rootProductId}).then(response => {
      debugger;
      buildTreeWithJSONArray(response.items[0].fields.subcategory, $('#nested-product-categories'), '', 1)
      setupEventListeners()
      getFieldValue()
    }).catch(console.error)
  });
</script>